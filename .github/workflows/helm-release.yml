name: Release Helm Charts

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'helm/myelectricaldata-server/**'
      - 'helm/myelectricaldata-client/**'
  workflow_dispatch:

# Prevent concurrent releases
concurrency:
  group: helm-release-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io

jobs:
  # ===========================================
  # STEP 1: Validate Both Charts
  # ===========================================
  validate:
    name: Validate Charts
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chart:
          - name: myelectricaldata-server
            path: helm/myelectricaldata-server
          - name: myelectricaldata-client
            path: helm/myelectricaldata-client
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Update dependencies
        run: helm dependency update ${{ matrix.chart.path }}

      - name: Lint chart
        run: helm lint ${{ matrix.chart.path }}

      - name: Template chart
        run: helm template ${{ matrix.chart.name }} ${{ matrix.chart.path }} --debug > /dev/null

  # ===========================================
  # STEP 2: Semantic Release for Helm Charts
  # ===========================================
  release:
    name: Semantic Release
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      packages: write
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Use Helm release config
        run: |
          # Backup original releaserc if exists
          if [ -f .releaserc.yaml ]; then
            mv .releaserc.yaml .releaserc.yaml.bak
          fi
          # Use helm-specific config
          cp .releaserc-helm.yaml .releaserc.yaml

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          extra_plugins: |
            @semantic-release/changelog@6.0.3
            @semantic-release/git@10.0.1
            semantic-release-replace-plugin@1.2.7
            conventional-changelog-conventionalcommits@8.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Restore original config
        if: always()
        run: |
          # Restore original releaserc
          if [ -f .releaserc.yaml.bak ]; then
            mv .releaserc.yaml.bak .releaserc.yaml
          else
            rm -f .releaserc.yaml
          fi

      - name: Release info
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          echo "## Helm Charts Release ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.semantic.outputs.new_release_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`helm/${{ steps.semantic.outputs.new_release_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Charts Updated" >> $GITHUB_STEP_SUMMARY
          echo "- myelectricaldata-server" >> $GITHUB_STEP_SUMMARY
          echo "- myelectricaldata-client" >> $GITHUB_STEP_SUMMARY

  # ===========================================
  # STEP 3: Package and Push to GHCR
  # ===========================================
  publish:
    name: Publish to GHCR
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        chart:
          - name: myelectricaldata-server
            path: helm/myelectricaldata-server
          - name: myelectricaldata-client
            path: helm/myelectricaldata-client
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          # Fetch latest to get the version bump commit
          fetch-depth: 1

      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}

      - name: Set lowercase owner
        id: repo
        run: |
          echo "owner=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Login to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Update Helm dependencies
        run: helm dependency update ${{ matrix.chart.path }}

      - name: Get chart version
        id: chart_version
        run: |
          VERSION=$(grep '^version:' ${{ matrix.chart.path }}/Chart.yaml | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $VERSION"

      - name: Package Helm chart
        run: |
          helm package ${{ matrix.chart.path }} --destination ./packages

      - name: Push to GHCR
        run: |
          CHART_PACKAGE=$(ls ./packages/${{ matrix.chart.name }}-*.tgz)
          helm push $CHART_PACKAGE oci://${{ env.REGISTRY }}/${{ steps.repo.outputs.owner }}/charts
          echo "Chart pushed to: oci://${{ env.REGISTRY }}/${{ steps.repo.outputs.owner }}/charts/${{ matrix.chart.name }}:${{ steps.chart_version.outputs.version }}"

      - name: Summary
        run: |
          VERSION="${{ steps.chart_version.outputs.version }}"

          if [[ "$VERSION" == *"-dev."* ]]; then
            RELEASE_TYPE="ðŸ§ª Development"
          else
            RELEASE_TYPE="ðŸš€ Production"
          fi

          echo "## Helm Chart Published ðŸ“¦ - ${{ matrix.chart.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release Type:** $RELEASE_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "**Chart:** ${{ matrix.chart.name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`helm/$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** oci://${{ env.REGISTRY }}/${{ steps.repo.outputs.owner }}/charts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "helm install ${{ matrix.chart.name }} oci://${{ env.REGISTRY }}/${{ steps.repo.outputs.owner }}/charts/${{ matrix.chart.name }} --version $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
