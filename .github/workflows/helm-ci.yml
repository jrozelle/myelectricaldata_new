name: Helm CI

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - 'helm/**'
  pull_request:
    paths:
      - 'helm/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate Charts
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chart:
          - name: myelectricaldata-server
            path: helm/myelectricaldata-server
          - name: myelectricaldata-client
            path: helm/myelectricaldata-client
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Update dependencies
        run: helm dependency update ${{ matrix.chart.path }}

      - name: Lint chart
        run: helm lint ${{ matrix.chart.path }}

      - name: Template chart (default values)
        run: |
          helm template ${{ matrix.chart.name }} ${{ matrix.chart.path }} \
            --debug \
            > /dev/null
          echo "✅ Template with default values succeeded"

      - name: Validate Chart.yaml
        run: |
          # Check required fields
          if ! grep -q "^version:" ${{ matrix.chart.path }}/Chart.yaml; then
            echo "❌ Missing version in Chart.yaml"
            exit 1
          fi
          if ! grep -q "^appVersion:" ${{ matrix.chart.path }}/Chart.yaml; then
            echo "❌ Missing appVersion in Chart.yaml"
            exit 1
          fi
          echo "✅ Chart.yaml validation passed"

      - name: Summary
        run: |
          VERSION=$(grep '^version:' ${{ matrix.chart.path }}/Chart.yaml | awk '{print $2}')
          APP_VERSION=$(grep '^appVersion:' ${{ matrix.chart.path }}/Chart.yaml | awk '{print $2}' | tr -d '"')

          echo "## Helm Chart Validation ✅ - ${{ matrix.chart.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Chart | \`${{ matrix.chart.name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Chart Version | \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| App Version | \`$APP_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Helm lint" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Helm template (default)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Chart.yaml validation" >> $GITHUB_STEP_SUMMARY
