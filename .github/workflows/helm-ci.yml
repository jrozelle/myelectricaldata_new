name: Helm CI

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
    paths:
      - 'helm/**'
  pull_request:
    paths:
      - 'helm/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CHART_PATH: helm/myelectricaldata

jobs:
  validate:
    name: Validate Chart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Update dependencies
        run: helm dependency update ${{ env.CHART_PATH }}

      - name: Lint chart
        run: helm lint ${{ env.CHART_PATH }}

      - name: Template chart (default values)
        run: |
          helm template myelectricaldata ${{ env.CHART_PATH }} \
            --debug \
            > /dev/null
          echo "✅ Template with default values succeeded"

      - name: Template chart (example values)
        if: hashFiles('helm/values-dev.yaml') != ''
        run: |
          helm template myelectricaldata ${{ env.CHART_PATH }} \
            -f helm/values-dev.yaml \
            --debug \
            > /dev/null
          echo "✅ Template with dev values succeeded"

      - name: Validate Chart.yaml
        run: |
          # Check required fields
          if ! grep -q "^version:" ${{ env.CHART_PATH }}/Chart.yaml; then
            echo "❌ Missing version in Chart.yaml"
            exit 1
          fi
          if ! grep -q "^appVersion:" ${{ env.CHART_PATH }}/Chart.yaml; then
            echo "❌ Missing appVersion in Chart.yaml"
            exit 1
          fi
          echo "✅ Chart.yaml validation passed"

      - name: Summary
        run: |
          VERSION=$(grep '^version:' ${{ env.CHART_PATH }}/Chart.yaml | awk '{print $2}')
          APP_VERSION=$(grep '^appVersion:' ${{ env.CHART_PATH }}/Chart.yaml | awk '{print $2}' | tr -d '"')

          echo "## Helm Chart Validation ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Chart Version | \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| App Version | \`$APP_VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Passed" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Helm lint" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Helm template (default)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Chart.yaml validation" >> $GITHUB_STEP_SUMMARY
